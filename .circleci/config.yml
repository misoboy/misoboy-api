version: 2
defaults:
  environment:

jobs:
  build_test:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace:
          at: /home/circleci

      # run test
      - run:
          name : Maven Test the Project
          command : |
            chmod +x mvnw
            ./mvnw -e clean package jacoco:report coveralls:report
            mkdir deploy
            cp ./target/*.jar ./deploy
            cp ./docker/* ./deploy

      - persist_to_workspace:
          root: /home/circleci/project
          paths:
            - deploy

  build_deploy:
    machine: true
    steps:
      - attach_workspace:
          at: /home/circleci/project

      - run:
          name: Docker Build & Deploy
          command: |
            docker login https://docker.pkg.github.com -u $GITHUB_PACKAGE_USERNAME -p $GITHUB_PACKAGE_PASSWORD
            STABLE_TAG='1.0'
            TAG="${STABLE_TAG}.${CIRCLE_BUILD_NUM}"
            TAGGED_IMAGE="docker.pkg.github.com/misoboy/misoboy-api/misoboy-api"
            STABLE_IMAGE="${TAGGED_IMAGE}:${STABLE_TAG}"
            IMAGE="${TAGGED_IMAGE}:${TAG}"
            echo "image: $IMAGE"
            echo "stable image: $STABLE_IMAGE"
            docker build -t "$IMAGE" ./deploy/
            docker tag "${IMAGE}" "${STABLE_IMAGE}"
            docker push "${IMAGE}"
            docker push "${STABLE_IMAGE}"

workflows:
  version: 2
  workflow:
    jobs:
      - build_test:
          filters:
            branches:
              only: master
      - build_deploy:
          context: GITHUB_SECRET
          requires:
            - build_test
          filters:
            branches:
              only: master
